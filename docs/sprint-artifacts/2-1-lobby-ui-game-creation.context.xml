<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Lobby UI &amp; Game Creation</title>
    <status>drafted</status>
    <generatedAt>s√∏ndag 30. november 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-lobby-ui-game-creation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Host</asA>
    <iWant>to create a new game and receive a unique code</iWant>
    <soThat>I can invite a friend to play</soThat>
    <tasks>
- [ ] Task 1: Create Game Setup UI (AC: 1)
  - [ ] Create page `app/game-lobby/page.tsx`.
  - [ ] Add UI for selecting difficulty (Easy, Medium, Hard) and a "Create" button.
- [ ] Task 2: Implement Game Creation Logic (AC: 2)
  - [ ] Create an API route `app/api/game/create/route.ts`.
  - [ ] The API will generate a unique code and create a `game_sessions` record in the database.
  - [ ] It will also create a `players` record for the host user.
- [ ] Task 3: Implement Redirection and Lobby UI (AC: 3, 4)
  - [ ] On successful creation, redirect the user to `/game/[code]`.
  - [ ] The lobby page should display the game code prominently.
  - [ ] Add a button to copy the game code to the clipboard.
</tasks>
  </story>

  <acceptanceCriteria>
1.  **Given** I am logged in on the Home page, **when** I click "Start a New Game", **then** I am taken to the Game Setup screen.
2.  **When** I select a Difficulty (Easy/Medium/Hard) and click "Create", **then** a new `game_session` record is created in the DB with `status: 'waiting'`.
3.  **And** I am redirected to the Lobby screen (`/game/[code]`).
4.  **And** the unique game code is displayed prominently with a copy button.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements</section>
        <snippet>FR1.1 - Game Creation: The system shall allow a user to create a new game session, generating a unique game code. FR1.2 - Game Joining: The system shall allow a user to join an existing game session by entering a valid game code. FR1.3 - Player Readiness: The system shall allow both players to confirm their readiness before starting a game. FR4.1 - Difficulty Settings: The system shall allow players to select game difficulty (Easy, Medium, Hard) which adjusts the number of characters.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Product Scope - MVP</section>
        <snippet>Two-Player Online Gameplay: Players can create or join a game room using a unique code, enabling the core social interaction. Difficulty Settings: Players can select from Easy (12 characters), Medium (24), and Hard (48) difficulty levels, offering replayability and catering to different skill levels.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>Epic 2: Game Session Management | Supabase Client, Zustand Store (Lobby), API Routes | app/game-lobby/, lib/supabase/, app/api/game/</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Decision Summary</section>
        <snippet>Real-time Engine: Supabase Realtime; State Management: Zustand; Data Persistence: Supabase (PostgreSQL).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>app/game-lobby/: Feature: Game Setup &amp; Lobby; app/api/: Backend API Routes (game/[game-id]/route.ts).</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Journey 1: Starting and Joining a Game</section>
        <snippet>User Goal: To quickly and effortlessly start a game with a friend. Approach: A simple, code-based lobby system that is intuitive and requires minimal steps. Covers Host and Guest player flows, game start, and error states.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Component Library</section>
        <snippet>Button, Input, AlertDialog/Dialog from shadcn/ui will be used for game creation, joining, and code display/confirmation.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 2: Game Session Management</section>
        <snippet>Goal: Enable users to create and join game sessions, ensuring two players can successfully connect and prepare to play. Scope: Game creation (generating codes), lobby system, game joining logic, player readiness state, and difficulty selection (Easy/Medium/Hard). FR Coverage: FR1.1, FR1.2, FR1.3, FR4.1.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Game Session Management</title>
        <section>Overview</section>
        <snippet>Outlines design and implementation details for Epic 2. Covers game creation, difficulty selection, game joining, real-time lobby, player readiness, and transition to gameplay.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Game Session Management</title>
        <section>Detailed Design - Services and Modules</section>
        <snippet>GameSessionService (`lib/services/game-session.ts`), LobbyStore (`app/game-lobby/store.ts`), LobbyPage (`app/game-lobby/page.tsx`), SupabaseRealtimeClient (`lib/supabase/client.ts`).</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Game Session Management</title>
        <section>Detailed Design - Data Models and Contracts</section>
        <snippet>Defines `game_sessions` table (id, code, status, hostId, difficulty, winnerId, createdAt) and `players` table (id, gameId, userId, isReady).</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Game Session Management</title>
        <section>Detailed Design - APIs and Interfaces</section>
        <snippet>API Endpoints: `POST /api/game/create` and `POST /api/game/join`. Real-time Events: `player-joined`, `player-ready`, `game-starting` on channel `game-[gameId]`.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Game Session Management</title>
        <section>Detailed Design - Workflows and Sequencing</section>
        <snippet>Details the step-by-step processes for Create Game Flow, Join Game Flow, and Game Start Flow, including frontend and backend interactions.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/services/game-session.ts</path>
        <kind>service</kind>
        <symbol>GameSessionService</symbol>
        <reason>Handles business logic for creating and managing game sessions, interacting with Supabase.</reason>
      </artifact>
      <artifact>
        <path>app/game-lobby/store.ts</path>
        <kind>zustand-store</kind>
        <symbol>LobbyStore</symbol>
        <reason>Manages client-side state for the lobby, including game code, player list, and readiness status, reacting to Realtime events.</reason>
      </artifact>
      <artifact>
        <path>app/game-lobby/page.tsx</path>
        <kind>component</kind>
        <symbol>LobbyPage</symbol>
        <reason>Main React component for the lobby UI, rendering game setup, waiting screens, and player list.</reason>
      </artifact>
      <artifact>
        <path>app/api/game/create/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST /api/game/create</symbol>
        <reason>Backend API endpoint to create a new game session and generate a unique code.</reason>
      </artifact>
      <artifact>
        <path>app/api/game/join/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST /api/game/join</symbol>
        <reason>Backend API endpoint to allow a player to join an existing game session.</reason>
      </artifact>
      <artifact>
        <path>db/schema.ts</path>
        <kind>database-schema</kind>
        <symbol>gameSessions, players</symbol>
        <reason>Defines the database tables and their structure for game sessions and players.</reason>
      </artifact>
    </code>
    <dependencies>
      <npm>
        <package name="@supabase/ssr" version="latest" />
        <package name="@supabase/supabase-js" version="latest" />
        <package name="next" version="latest" />
        <package name="react" version="^19.0.0" />
        <package name="react-dom" version="^19.0.0" />
        <package name="zustand" version="latest"> (Note: This is required but not yet in package.json. Will need to be added.)</package>
        <package name="class-variance-authority" version="^0.7.1" />
        <package name="clsx" version="^2.1.1" />
        <package name="lucide-react" version="^0.511.0" />
        <package name="next-themes" version="^0.4.6" />
        <package name="tailwind-merge" version="^3.3.0" />
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Performance: Lobby UI updates &lt; 500ms latency (via Supabase Realtime).</constraint>
    <constraint>Performance: API response time for /api/game/create and /api/game/join &lt; 750ms.</constraint>
    <constraint>Security: All API endpoints and database interactions must require authenticated user sessions (Supabase Auth).</constraint>
    <constraint>Security: RLS policies on `game_sessions` and `players` tables to enforce authorization rules.</constraint>
    <constraint>Security: Input validation for game `code` (e.g., 6-character format) and `difficulty` (enum values).</constraint>
    <constraint>Reliability: Graceful handling of WebSocket disconnections (auto-reconnect for 30s).</constraint>
    <constraint>Reliability: Clear UI communication for errors (e.g., "Invalid game code", "Game is full").</constraint>
    <constraint>Reliability: Atomic game joining logic to prevent race conditions.</constraint>
    <constraint>Project Structure: Adherence to feature-sliced design (`app/game-lobby/`, `lib/services/`, `app/api/`).</constraint>
    <constraint>Naming Conventions: `kebab-case` for files/folders, `PascalCase` for React components, `camelCase` for functions/variables, `snake_case` for database tables/columns, `SCREAMING_SNAKE_CASE` for environment variables.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>POST /api/game/create</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/game/create { "difficulty": "Easy" | "Medium" | "Hard" }</signature>
      <path>app/api/game/create/route.ts</path>
    </interface>
    <interface>
      <name>POST /api/game/join</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/game/join { "code": "ABC-DEF" }</signature>
      <path>app/api/game/join/route.ts</path>
    </interface>
    <interface>
      <name>Supabase Realtime Channel</name>
      <kind>Broadcast channel</kind>
      <signature>channel: "game-[gameId]"</signature>
      <path>lib/supabase/client.ts</path>
    </interface>
    <interface>
      <name>Supabase Realtime Event: player-joined</name>
      <kind>Realtime event</kind>
      <signature>payload: { "userId": "...", "username": "..." }</signature>
      <path>lib/supabase/client.ts</path>
    </interface>
    <interface>
      <name>Supabase Realtime Event: player-ready</name>
      <kind>Realtime event</kind>
      <signature>payload: { "userId": "...", "isReady": true }</signature>
      <path>lib/supabase/client.ts</path>
    </interface>
    <interface>
      <name>Supabase Realtime Event: game-starting</name>
      <kind>Realtime event</kind>
      <signature>payload: {}</signature>
      <path>lib/supabase/client.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      <standard>Unit tests using Jest and React Testing Library for isolated component and store logic.</standard>
      <standard>Integration tests using Jest and React Testing Library for API routes and component-store interactions.</standard>
      <standard>End-to-End (E2E) tests using Playwright/Cypress (TBD) for full user journeys.</standard>
    </standards>
    <locations>
      <location>digital-guess-who/__tests__/</location>
      <location>Unit tests co-located with components/stores (e.g., `app/game-lobby/__tests__/`)</location>
    </locations>
    <ideas>
      <test-idea ac-id="1">
        <description>E2E: Simulate a logged-in user clicking "Start a New Game", selecting difficulty, and verifying redirection to lobby with a displayed code.</description>
      </test-idea>
      <test-idea ac-id="2">
        <description>Integration: Test `POST /api/game/create` endpoint to ensure a new `game_session` and `players` record are created correctly.</description>
      </test-idea>
      <test-idea ac-id="3">
        <description>Unit: Test `LobbyStore` to ensure it correctly updates state when a game is created.</description>
      </test-idea>
      <test-idea ac-id="4">
        <description>E2E: Verify the copy button for the game code works as expected.</description>
      </test-idea>
    </ideas>
  </tests>
</story-context>