<story-context id="3-2-turn-management-system" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3-2</storyId>
    <title>Turn Management System</title>
    <status>drafted</status>
    <generatedAt>Sunday, December 14, 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-2-turn-management-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Player</asA>
    <iWant>to clearly see whose turn it is</iWant>
    <soThat>I know when I can ask a question or when I need to wait</soThat>
    <tasks>
      <task status="pending">Implement Client-Side Turn State Management (AC: 1, 2)
        <subtasks>
          <subtask>Extend useGameStore (lib/store/game.ts) to manage current_turn_player_id and derived isMyTurn state.</subtask>
          <subtask>Implement UI logic in app/game-play/[code]/page.tsx to enable/disable "Ask Question" and "Make Guess" buttons based on isMyTurn.</subtask>
          <subtask>Create/integrate a visual "Your Turn" indicator component in app/game-play/[code]/page.tsx.</subtask>
          <subtask>Implement a visual "Opponent's Turn" indicator.</subtask>
        </subtasks>
      </task>
      <task status="pending">Implement Server-Side Turn Transition Logic (AC: 3)
        <subtasks>
          <subtask>Implement Supabase Function/Trigger to switch current_turn_player_id in game_sessions after a question/answer action is completed.</subtask>
          <subtask>Ensure current_turn_player_id is updated in game_sessions via Realtime.</subtask>
        </subtasks>
      </task>
      <task status="pending">Integrate Realtime Turn Events (AC: 3)
        <subtasks>
          <subtask>Extend lib/hooks/use-gameplay-subscription.ts to listen for turn-change events on the game:[game_id] Realtime channel.</subtask>
          <subtask>Dispatch turn-change events to useGameStore to update client-side current_turn_player_id.</subtask>
        </subtasks>
      </task>
      <task status="pending">Testing &amp; Verification
        <subtasks>
          <subtask>Unit Test: Add tests to lib/store/game.ts for useGameStore logic related to current_turn_player_id updates and isMyTurn derivation.</subtask>
          <subtask>Unit Test: Verify turn switching logic correctly handles edge cases.</subtask>
          <subtask>Integration Test: Implement RealtimeTestHarness to simulate turn-change events.</subtask>
          <subtask>UI Test: Create UI tests for app/game-play/[code]/page.tsx to verify turn indicators and button states.</subtask>
          <subtask>UI Test: Verify visual state persists correctly after a page reload.</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given It is my turn Then The "Ask Question" and "Make Guess" UI is enabled And I see a "Your Turn" indicator.</criterion>
    <criterion id="2">Given It is the opponent's turn Then My action UI is disabled And I see "Opponent's Turn".</criterion>
    <criterion id="3">When A turn ends (question asked &amp; answered), ownership switches automatically.</criterion>
    <criterion id="4">UI clearly indicates "Your Turn" vs "Opponent's Turn".</criterion>
    <criterion id="5">Active player inputs are enabled; Waiting player inputs are disabled.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic 3 Technical Specification</title>
        <section>Detailed Design > Workflows and Sequencing</section>
        <snippet>Turn Sequence: 1. Start: game_sessions.current_turn_player_id is set. 2. Active Player: UI enables "Ask Question" / "Make Guess". 3. Action (Question/Answer): Syncs via Realtime Broadcast.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns > 4. Communication Patterns</section>
        <snippet>Event Names: turn-changed: Active player ended their turn. Channel Naming: game:[game-id].</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics Summary</title>
        <section>Epic 3: Core Gameplay Loop > Story 3.2</section>
        <snippet>Goal: Implement the complete turn-based game experience. Arch: game_sessions table needs current_turn_player_id. Realtime: Listen for updates.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements > Gameplay Mechanics</section>
        <snippet>FR3.1 - Turn-Based Play: The system shall enforce turn-based gameplay, alternating between players. Only the active player can perform actions.</snippet>
      </doc>
      <doc>
        <path>docs/unified-project-structure.md</path>
        <title>Unified Project Structure</title>
        <section>2. app/ Directory (Next.js App Router)</section>
        <snippet>app/game-lobby/: Feature-sliced directory... components/: ... lib/: ...</snippet>
      </doc>
      <doc>
        <path>docs/coding-standards.md</path>
        <title>Coding Standards</title>
        <section>Naming Conventions</section>
        <snippet>Files &amp; Directories: kebab-case... React Components: PascalCase...</snippet>
      </doc>
      <doc>
        <path>docs/testing-strategy.md</path>
        <title>Testing Strategy</title>
        <section>3. Integration Testing (Manual &amp; API)</section>
        <snippet>Scope: Full game flows... Supabase Realtime events... Standard: All User Stories must pass manual verification...</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/3-1-game-board-secret-character-selection.md</path>
        <title>Story 3.1: Game Board &amp; Secret Character Selection</title>
        <section>Learnings from Previous Story</section>
        <snippet>New Services/Patterns to Reuse: player_secrets table... useGameStore for client state, useGameplaySubscription for Realtime events.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>digital-guess-who/lib/store/game.ts</path>
        <kind>state-management</kind>
        <symbol>useGameStore</symbol>
        <lines>25-58</lines>
        <reason>Primary store for game state. Needs extension for `isMyTurn` derivation and `currentTurnPlayerId` management logic.</reason>
      </item>
      <item>
        <path>digital-guess-who/lib/hooks/use-gameplay-subscription.ts</path>
        <kind>hook</kind>
        <symbol>useGameplaySubscription</symbol>
        <lines>10-50</lines>
        <reason>Handles Realtime subscription. Already listens to `game_sessions` UPDATEs, which includes `current_turn_player_id`. Needs verification/extension for specific `turn-change` events if not covered by generic UPDATE.</reason>
      </item>
      <item>
        <path>digital-guess-who/db/schema.ts</path>
        <kind>database</kind>
        <symbol>game_sessions</symbol>
        <lines>15-24</lines>
        <reason>Defines the `game_sessions` table with `current_turn_player_id` column.</reason>
      </item>
    </code>
    <dependencies>
      <dep key="zustand">State management for local turn state</dep>
      <dep key="@supabase/supabase-js">Realtime subscription client</dep>
      <dep key="shadcn/ui">Components for visual indicators (Badges, disabled buttons)</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Performance: Turn updates must occur within 500ms.</constraint>
    <constraint>Architecture: Use `useGameStore` for client state; `game_sessions` for authoritative server state.</constraint>
    <constraint>Reconnection: If a player refreshes, `useGameStore` should re-hydrate state from `game_sessions`.</constraint>
    <constraint>Security: While turn state is public, ensure only the active player can submit actions via RLS or API validation.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>game_sessions table</name>
      <kind>Database Table</kind>
      <signature>current_turn_player_id: uuid (FK to users.id)</signature>
      <path>digital-guess-who/db/schema.ts</path>
    </interface>
    <interface>
      <name>Realtime Channel</name>
      <kind>Supabase Realtime</kind>
      <signature>game:[game-id] -> postgres_changes (UPDATE game_sessions)</signature>
      <path>digital-guess-who/lib/hooks/use-gameplay-subscription.ts</path>
    </interface>
    <interface>
      <name>useGameStore</name>
      <kind>Zustand Store</kind>
      <signature>isMyTurn: boolean; currentTurnPlayerId: string | null; setTurn(isMyTurn: boolean): void;</signature>
      <path>digital-guess-who/lib/store/game.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest for unit tests (`lib/store/game.ts`). Integration tests should simulate Realtime events using a test harness or mock Supabase client. UI tests should verify button states (enabled/disabled) and visual indicators.</standards>
    <locations>digital-guess-who/tests/unit, digital-guess-who/tests/integration</locations>
    <ideas>
      <idea id="1">Test `useGameStore` correctly derives `isMyTurn` when `currentTurnPlayerId` matches the logged-in user.</idea>
      <idea id="2">Test `useGameStore` updates `isMyTurn` to false when `currentTurnPlayerId` changes to opponent.</idea>
      <idea id="3">Test `useGameplaySubscription` correctly dispatches `setCurrentTurn` when a Realtime UPDATE arrives.</idea>
      <idea id="4">Verify UI buttons are `disabled` when `isMyTurn` is false.</idea>
    </ideas>
  </tests>
</story-context>
