<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.2</storyId>
    <title>Turn Management System</title>
    <status>drafted</status>
    <generatedAt>2025-12-01T12:00:00Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-2-turn-management-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Player</asA>
    <iWant>to clearly see whose turn it is</iWant>
    <soThat>I know when I can ask a question or when I need to wait</soThat>
    <tasks>
- [ ] **Backend: Update Database Schema** (AC: #3, #4)
    - [ ] Add a `current_turn_player_id` column of type `uuid` to the `game_sessions` table, referencing `players(id)`.
- [ ] **Backend: Real-time Logic** (AC: #3)
    - [ ] Implement logic to update `current_turn_player_id` in the database when a turn-ending action is completed.
    - [ ] Ensure the Supabase Realtime channel (`game:[game-id]`) broadcasts the `turn-changed` event with the new `current_turn_player_id`.
- [ ] **Frontend: State Management** (AC: #1, #2)
    - [ ] Update the Zustand game store to hold `currentTurnPlayerId`.
    - [ ] Implement the client-side listener for the `turn-changed` event to update the Zustand store.
- [ ] **Frontend: UI Implementation** (AC: #1, #2)
    - [ ] Create a "Turn Indicator" UI component that displays "Your Turn" or "Opponent's Turn" based on the state in the Zustand store.
    - [ ] Conditionally disable/enable action buttons ("Ask Question", "Make Guess") based on whether the current user is the active player.
- [ ] **Testing** (AC: #1, #2, #3)
    - [ ] Write unit tests for the Zustand store to verify correct handling of `currentTurnPlayerId` updates.
    - [ ] Write an integration test to mock the Supabase Realtime 'turn-changed' event and assert that the UI correctly enables/disables action buttons and updates the turn indicator.
    - [ ] Write a backend test for the turn-change logic if possible within the current test setup.
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Given** It is my turn, **then** the "Ask Question" and "Make Guess" UI is enabled and I see a "Your Turn" indicator.
2. **Given** It is the opponent's turn, **then** my action UI is disabled and I see "Opponent's Turn".
3. **When** a turn ends (e.g., after a question is asked and answered), **then** ownership of the turn automatically switches to the other player.
4. The system correctly identifies the first turn of the game (randomly or Host first).
  </acceptanceCriteria>

  <artifacts>
    <docs>
        <entry path="docs/architecture.md" title="Architecture" section="Communication Patterns (Supabase Realtime)" snippet="Defines the event names and channel naming conventions (game:[game-id]) for real-time communication."/>
        <entry path="docs/architecture.md" title="Architecture" section="Data Architecture" snippet="Outlines the core data models, including game_sessions, which this story will modify."/>
        <entry path="docs/epics.md" title="Epics" section="Story 3.2: Turn Management System" snippet="Specifies the user story and acceptance criteria for the turn management system."/>
        <entry path="docs/tech-spec-epic-3.md" title="Tech Spec - Epic 3" section="Technical Implementation Plan" snippet="Details the plan to use SupabaseRealtimeService to manage turn-changed events and update the game_sessions table."/>
    </docs>
    <code>
        <entry path="digital-guess-who/db/schema.ts" kind="schema" symbol="game_sessions" lines="" reason="This file defines the database schema and must be modified to add the 'current_turn_player_id' column to the 'game_sessions' table."/>
        <entry path="digital-guess-who/lib/services/game-session.ts" kind="service" symbol="-" lines="" reason="This service likely contains functions for interacting with the game_sessions table. It may need to be updated with a function to handle turn changes."/>
        <entry path="digital-guess-who/app/game-lobby/[code]/page.tsx" kind="component" symbol="-" lines="" reason="This is an existing component that already uses Supabase Realtime for the lobby. It serves as a reference implementation for subscribing to a game channel and handling events."/>
        <entry path="digital-guess-who/lib/supabase/client.ts" kind="configuration" symbol="supabase" lines="" reason="This file contains the Supabase client configuration, which is the entry point for all Supabase interactions, including Realtime."/>
    </code>
    <dependencies>
        <dependency name="@supabase/supabase-js" version="latest" />
        <dependency name="@supabase/ssr" version="latest" />
        <dependency name="next" version="latest" />
        <dependency name="react" version="^19.0.0" />
        <dependency name="zustand" version="Not in package.json, but mentioned in docs. Needs to be added if not present." />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All turn changes must be transactional database updates that then trigger Realtime events.</constraint>
    <constraint>The `game_sessions` table is the single source of truth for whose turn it is.</constraint>
    <constraint>The communication pattern is: Event -> update DB -> DB triggers Realtime broadcast -> clients sync state.</constraint>
    <constraint>The Realtime channel name must be `game:[game-id]`.</constraint>
  </constraints>

  <interfaces>
    <interface name="Turn Changed Event" kind="Realtime Event" signature="{ event: 'turn-changed', payload: { nextPlayerId: 'uuid' } }" path=""/>
  </interfaces>
  
  <tests>
    <standards>Unit tests should verify the Zustand store logic. Integration tests should simulate a `turn-changed` event from Supabase and confirm the UI reacts correctly.</standards>
    <locations>
        <location>tests/unit/</location>
        <location>tests/integration/</location>
    </locations>
    <ideas>
        <idea acId="1, 2">Mock a 'turn-changed' Realtime event and verify the UI correctly enables/disables action buttons and displays the correct turn indicator.</idea>
        <idea acId="3">Write a service-level test that calls a `endTurn()` function and verifies the `current_turn_player_id` is correctly updated in the mock database.</idea>
    </ideas>
  </tests>
</story-context>