<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Game Board &amp; Secret Character Selection</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-1-game-board-secret-character-selection.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Player</asA>
    <iWant>to see the grid of characters and select my secret identity</iWant>
    <soThat>the game can begin</soThat>
    <tasks>
      - [ ] **Backend: Secure Character Selection** (AC: 3)
          - [ ] Refine RLS policy on `players` table to allow a user to update ONLY their own `character_id` and only if it is currently `null`.
          - [ ] Ensure the RLS policy for `SELECT` on the `players` table does NOT expose the `character_id` to the opponent.

      - [ ] **Frontend: Character Data Fetching** (AC: 1)
          - [ ] Create a service or utility function to fetch the character set based on the game's difficulty setting. For MVP, this can be from a static JSON file in `public/assets/data/characters.json`.
          - [ ] Define the TypeScript type for a `Character`.

      - [ ] **Frontend: Create Game Board UI Components** (AC: 1, 2)
          - [ ] Create a `CharacterCard` component at `app/game-play/components/CharacterCard.tsx`. It should have visual states for `default`, `selected`, and `eliminated`.
          - [ ] Create a `CharacterGrid` component at `app/game-play/components/CharacterGrid.tsx` that fetches the character data and renders the `CharacterCard` components in a grid layout.

      - [ ] **Frontend: Implement State Management (Zustand)** (AC: 2, 3, 4)
          - [ ] Create a new Zustand store at `app/game-play/store.ts` to manage the game state.
          - [ ] State should include `characters`, `mySecretCharacter`, `opponentSecretCharacter` (which will remain null), `turn`, and `gameState` (e.g., 'selecting', 'playing', 'finished').
          - [ ] Implement actions for `selectCharacter`, `confirmCharacter`, and to handle real-time updates.

      - [ ] **Frontend: Implement Real-time Synchronization** (AC: 4)
          - [ ] In the `app/game-play/page.tsx` component, subscribe to the `game:[gameId]` channel.
          - [ ] Listen for an event (e.g., `opponent-ready`) that signals the other player has selected their character.
          - [ ] When both players are ready, update the Zustand store to change the `gameState` to `playing` and set the initial `turn`.

      - [ ] **Testing** (AC: 1, 2, 3, 4)
          - [ ] Write unit tests for the `GamePlayStore`.
          - [ ] Per learnings from the previous story, create a placeholder for future E2E tests to simulate two users selecting characters and the game starting.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **AC1 (Character Grid Display):**
        -   **Given** the game has started and I am on the gameplay screen,
        -   **Then** I see a grid of character cards.
        -   **And** the number of cards corresponds to the difficulty selected in the lobby (Easy: 12, Medium: 24, Hard: 48).

    2.  **AC2 (Secret Character Selection):**
        -   **Given** the character grid is displayed,
        -   **When** I click on a character card,
        -   **Then** the card is visually highlighted to indicate it is my selection.
        -   **And** a "Confirm Selection" button becomes active.

    3.  **AC3 (Selection Confirmation):**
        -   **Given** I have selected a character,
        -   **When** I click "Confirm Selection",
        -   **Then** my selection is saved to my `players` record in the database (`character_id`).
        -   **And** my selection UI is locked (I cannot change my character).
        -   **And** I see a "Waiting for opponent to select..." message.

    4.  **AC4 (Game Activation):**
        -   **Given** both players have confirmed their secret characters,
        -   **Then** the "Waiting for opponent" message disappears.
        -   **And** the main game interface becomes active.
        -   **And** the turn indicator shows whose turn it is (randomly assigned or Host first).
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <entry path="docs/epics.md" title="ibe160 - Epic Breakdown" section="Epic 3: Core Gameplay Loop" snippet="Implement the complete turn-based game experience, allowing players to select characters, ask questions, eliminate options, and determine a winner."/>
      <entry path="docs/PRD.md" title="ibe160 - Product Requirements Document" section="Functional Requirements: Character Management" snippet="FR2.1 - Secret Character Selection: The system shall allow each player to secretly select one character from the available grid."/>
      <entry path="docs/architecture.md" title="Architecture" section="Epic to Architecture Mapping" snippet="Epic 3: Core Gameplay Loop maps to Supabase Realtime, Zustand Store (Game), and Feature Components in app/game-play/."/>
      <entry path="docs/sprint-artifacts/tech-spec-epic-3.md" title="Epic Technical Specification: Core Gameplay Loop" section="Overview" snippet="This epic covers the complete implementation of the core gameplay loop for 'Digital Guess Who.' It encompasses all functionality required for players to play the game from start to finish."/>
      <entry path="docs/sprint-artifacts/2-3-real-time-lobby-player-readiness.md" title="Story 2.3: Real-time Lobby &amp; Player Readiness" section="Dev Notes: Learnings from Previous Story" snippet="Continue using the Supabase Realtime channel pattern and Zustand for state management. Address E2E test gap."/>
    </docs>
    <code>
      <entry path="app/game-play/store/game-store.ts" kind="Zustand Store" symbol="useGameStore" lines="" reason="Existing Zustand store for game state. To be extended for character selection."/>
      <entry path="app/game-lobby/[code]/page.tsx" kind="Next.js Page" symbol="" lines="105" reason="Contains navigation to the game-play screen."/>
      <entry path="supabase/migrations/20251201100000_refine_player_rls.sql" kind="SQL Migration" symbol="" lines="" reason="RLS policy from previous story. Relevant for securing character_id in players table."/>
      <entry path="db/schema.ts" kind="TypeScript Schema" symbol="GameSession, Player, Move" lines="" reason="Defines database schema for game entities. Relevant for character_id storage."/>
    </code>
    <dependencies>
      <entry name="@radix-ui/react-checkbox" version="^1.3.1"/>
      <entry name="@radix-ui/react-dropdown-menu" version="^2.1.14"/>
      <entry name="@radix-ui/react-label" version="^2.1.6"/>
      <entry name="@radix-ui/react-slot" version="^1.2.4"/>
      <entry name="@supabase/ssr" version="latest"/>
      <entry name="@supabase/supabase-js" version="latest"/>
      <entry name="class-variance-authority" version="^0.7.1"/>
      <entry name="clsx" version="^2.1.1"/>
      <entry name="lucide-react" version="^0.511.0"/>
      <entry name="next" version="latest"/>
      <entry name="next-themes" version="^0.4.6"/>
      <entry name="react" version="^19.0.0"/>
      <entry name="react-dom" version="^19.0.0"/>
      <entry name="tailwind-merge" version="^3.3.0"/>
      <entry name="zustand" version="~ (needs to be added)"/>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="Security">Opponent's secret `character_id` must not be exposed to the client. RLS on `players` table is critical. Final guess must be server-side validated.</constraint>
    <constraint type="Dependency">`zustand` needs to be installed as a new dependency.</constraint>
    <constraint type="Code Quality">Refine `Player` type definition for robustness.</constraint>
    <constraint type="Logging">Replace `console.error` with a production-grade logger.</constraint>
    <constraint type="Performance">Real-time synchronization &lt; 500ms; UI responsiveness &lt; 100ms.</constraint>
    <constraint type="Data Source">Character data source will be a static JSON file for MVP.</constraint>
  </constraints>
  <interfaces>
    <interface name="Guess API" kind="REST endpoint" signature="POST /api/game/{game-id}/guess" path="app/api/game/[game-id]/guess/route.ts (to be created)"/>
    <interface name="Supabase Realtime Channel" kind="Realtime Channel" signature="channel: game:{game-id}" path="lib/supabase/client.ts (to be used)"/>
    <interface name="Turn Changed Event" kind="Realtime Event" signature="{ 'nextPlayerId': 'uuid' }" path=""/>
    <interface name="Question Asked Event" kind="Realtime Event" signature="{ 'question': 'string' }" path=""/>
    <interface name="Answer Received Event" kind="Realtime Event" signature="{ 'answer': 'yes' | 'no' }" path=""/>
  </interfaces>
  <tests>
    <standards>
      <standard>Unit Tests (Jest / React Testing Library) for individual React components and Zustand store.</standard>
      <standard>Integration Tests (Jest / React Testing Library) for interactions between components and services within the `game-play` feature slice.</standard>
      <standard>Manual Testing for E2E user experience and real-time interaction, especially for latency and race conditions.</standard>
    </standards>
    <locations>
      <location>tests/unit/game-logic/game-store.test.ts</location>
      <location>digital-guess-who/__tests__/game-lobby/store.test.ts</location>
    </locations>
    <ideas>
      <idea acId="AC1, AC2, AC3, AC4">Write unit tests for the `GamePlayStore` (new store or extended `game-store.ts`) to verify character selection, confirmation, and state transitions.</idea>
      <idea acId="AC1, AC2, AC3, AC4">Create a placeholder for future E2E tests to simulate two users selecting characters and the game starting, addressing the known E2E test gap.</idea>
      <idea acId="AC1, AC2">Test the `CharacterCard` component to ensure it renders correctly in 'default', 'selected', and 'eliminated' states.</idea>
      <idea acId="AC1">Test the `CharacterGrid` component to assert that the number of `CharacterCard` children matches the game's difficulty setting.</idea>
      <idea acId="AC3">Test that clicking a card visually highlights it and activates the "Confirm Selection" button.</idea>
      <idea acId="AC4">Mock Supabase Realtime events for `opponent-ready` and assert that the game state transitions to 'playing' and the turn indicator is set.</idea>
    </ideas>
  </tests>
</story-context>