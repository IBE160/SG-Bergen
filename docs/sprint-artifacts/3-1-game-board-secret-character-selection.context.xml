<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Game Board &amp; Secret Character Selection</title>
    <status>drafted</status>
    <generatedAt>2025-12-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-1-game-board-secret-character-selection.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Player</asA>
    <iWant>to see the grid of characters and select my secret identity</iWant>
    <soThat>the game can begin</soThat>
    <tasks>
      <task>Implement Game Board UI (AC: 1)</task>
      <subtask>Create `CharacterGrid` component in `app/game-play/components`.</subtask>
      <subtask>Create `CharacterCard` component in `app/game-play/components` (display image, name).</subtask>
      <subtask>Implement `useGameStore` (Zustand) to manage `characters` list and `selectedCharacterId`.</subtask>
      <subtask>Fetch character data (static or DB) based on difficulty level from `game_session`.</subtask>
      <task>Implement Secret Selection Logic (AC: 2)</task>
      <subtask>Add `selectCharacter` action to `useGameStore`.</subtask>
      <subtask>Implement `handleCharacterSelection` in `app/game-play/page.tsx` to update `players` table (`character_id`).</subtask>
      <subtask>Ensure `players` table RLS policies prevent reading `character_id` of other players.</subtask>
      <task>Implement Game Start &amp; Turn Assignment (AC: 3)</task>
      <subtask>Update `useGameSubscription` to listen for `UPDATE` on `players` (checking if both have `character_id`).</subtask>
      <subtask>Create API route or secure logic (if Host) to set `current_turn_player_id` in `game_sessions` once both selected.</subtask>
      <subtask>Update `game_sessions` status to `playing`.</subtask>
      <subtask>Visual indicator for "Waiting for opponent to select...".</subtask>
      <task>Testing &amp; Verification</task>
      <subtask>Unit Test: `useGameStore` selection logic.</subtask>
      <subtask>Integration Test: Verify `character_id` update is rejected if not own user (RLS check).</subtask>
      <subtask>UI Test: Verify grid renders correct count and selection highlights.</subtask>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criteria id="1">Given The game has started (both players ready) Then I see a grid of character cards (count based on difficulty: Easy=12, Medium=24, Hard=48)</criteria>
    <criteria id="2">When I click a character to select it as my secret identity Then It is visually highlighted/confirmed And The selection is saved to my `players` record in the database And The opponent cannot see my selection via network inspection (RLS protected)</criteria>
    <criteria id="3">When Both players have selected their secret characters Then The main game interface activates (Transition to "Play" mode) And The first turn is assigned (randomly or Host first) and synced via Realtime</criteria>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Core Gameplay Loop</title>
        <section>Detailed Design</section>
        <snippet>This implementation aligns with the Frontend Architecture by utilizing Zustand (useGameStore) for managing the complex, immediate client-side state and Supabase Realtime for synchronizing the critical shared state. It adheres to the Backend Architecture by using Next.js API Routes for sensitive operations.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Players Table (Sensitive): SELECT: Restricted to authenticated users. Planned upgrade for Epic 3: Restrict character_id visibility via a separate view or RLS.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements</section>
        <snippet>FR2.1 - Secret Character Selection: The system shall allow each player to secretly select one character from the available grid. The selection is confirmed and cannot be changed after confirmation.</snippet>
      </doc>
      <doc>
        <path>docs/design/secret-character-selection.md</path>
        <title>Secure Secret Character Selection &amp; Verification Design</title>
        <section>Security Requirement</section>
        <snippet>The opponent's `character_id` must NEVER be sent to the client. The `players` table needs strict RLS policies to prevent data leakage.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Visual Design</section>
        <snippet>General design principles for the game board, emphasizing clarity and distinctiveness of character cards.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>digital-guess-who/app/game-play/[code]/page.tsx</path>
        <kind>page</kind>
        <symbol>GamePage</symbol>
        <lines>1-12</lines>
        <reason>Main orchestrator for the gameplay feature, needs to handle character selection state.</reason>
      </item>
      <item>
        <path>digital-guess-who/lib/store/game.ts</path>
        <kind>file</kind>
        <symbol>useGameStore</symbol>
        <lines>New File</lines>
        <reason>New Zustand store required for managing local board state and selection.</reason>
      </item>
      <item>
        <path>digital-guess-who/lib/hooks/use-game-subscription.ts</path>
        <kind>hook</kind>
        <symbol>useGameSubscription</symbol>
        <lines>44-55</lines>
        <reason>Needs update to listen for player updates (both selected character).</reason>
      </item>
    </code>
    <dependencies>
      <dep>zustand</dep>
      <dep>@supabase/supabase-js</dep>
      <dep>shadcn/ui</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>RLS Policy: Opponent's `character_id` MUST NOT be readable by the client.</constraint>
    <constraint>State Management: Use Zustand for client-side state (selection, elimination), not React Context.</constraint>
    <constraint>Realtime: Use Supabase Realtime for syncing turn status and game start.</constraint>
    <constraint>Architecture: Follow Feature-Sliced Design (components inside `app/game-play/components`).</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>players table</name>
      <kind>Database Table</kind>
      <signature>id (uuid), game_id (uuid), user_id (uuid), character_id (int), is_ready (bool)</signature>
      <path>db/schema.ts</path>
    </interface>
    <interface>
      <name>game_sessions table</name>
      <kind>Database Table</kind>
      <signature>status (enum: waiting, playing, finished), current_turn_player_id (uuid)</signature>
      <path>db/schema.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest/Jest for unit tests of the store. Use React Testing Library for UI components.</standards>
    <locations>tests/unit, tests/ui</locations>
    <ideas>
      <idea>Unit: Test `selectCharacter` action in `useGameStore` updates state correctly.</idea>
      <idea>Integration: Attempt to select a character for another player (should fail/mocked).</idea>
      <idea>UI: Render `CharacterGrid` with 12/24/48 items based on props.</idea>
    </ideas>
  </tests>
</story-context>
